rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    function isSuperAdmin() {
      return isSignedIn() && getUserData().role == 'super_admin';
    }
    function isAdmin() {
      return isSignedIn() && getUserData().role == 'admin';
    }
    function isStudent() {
      return isSignedIn() && getUserData().role == 'student';
    }
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // --- Users Collection (Application Form & Profile) ---
    match /users/{userId} {
      // Create: Allow user to register themselves
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      // Read: Owner, Admin, SuperAdmin, or if the target user is an Admin/SuperAdmin (so students can find them)
      allow read: if isOwner(userId) || isAdmin() || isSuperAdmin() || (resource.data.role in ['admin', 'super_admin']);
      
      // Write: Owner (update profile/form), SuperAdmin (manage users)
      // Admin cannot delete/edit users, only SuperAdmin can
      allow update: if isOwner(userId) || isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    // --- Applications ---
    match /applications/{appId} {
      allow read: if resource.data.studentId == request.auth.uid || isAdmin() || isSuperAdmin();
      allow create: if (request.resource.data.studentId == request.auth.uid) || isAdmin() || isSuperAdmin();
      allow update: if isAdmin() || isSuperAdmin() || (resource.data.studentId == request.auth.uid);
      allow delete: if isAdmin() || isSuperAdmin();
    }

    // --- Documents Collection ---
    match /documents/{docId} {
      // Read: Owner, Admin, SuperAdmin
      allow read: if resource.data.studentId == request.auth.uid || isAdmin() || isSuperAdmin();
      
      // Create: Student (own docs), Admin, SuperAdmin
      allow create: if (request.resource.data.studentId == request.auth.uid) || isAdmin() || isSuperAdmin();
      
      // Update/Delete: Admin, SuperAdmin (Students cannot delete after upload unless we want them to?)
      // User requirement: "Admin should be able to view all documents... Super admin should have full access"
      // Assuming students can delete their own pending docs? For now, let's restrict delete to Admins/SuperAdmins for safety, or allow owner.
      allow update, delete: if isAdmin() || isSuperAdmin() || (resource.data.studentId == request.auth.uid && resource.data.status == 'pending');
    }

    // --- Personal Statement Generator (Templates) ---
    match /ps_templates/{templateId} {
      // Read: Admin, SuperAdmin (Students don't need to see templates directly, they use the generated output)
      allow read: if isAdmin() || isSuperAdmin();
      
      // Write: SuperAdmin, Admin
      allow write: if isAdmin() || isSuperAdmin();
    }

    // --- Personal Statements (Generated) ---
    match /personal_statements/{statementId} {
      allow read: if resource.data.generatedBy == request.auth.uid || isAdmin() || isSuperAdmin();
      allow create: if request.resource.data.generatedBy == request.auth.uid || isAdmin() || isSuperAdmin();
      allow update, delete: if resource.data.generatedBy == request.auth.uid || isAdmin() || isSuperAdmin();
    }

    // --- Messages (Chatbot) ---
    match /messages/{messageId} {
      // Read: Participants (Sender or Receiver), Admin, SuperAdmin (Admins can see all student messages?)
      // Requirement: "All students should be able to directly message the Admin and Superadmin... any of them can answer"
      // This implies a shared inbox for Admins. 
      // So if user is Student: read own messages.
      // If user is Admin/SuperAdmin: read ALL messages.
      allow read: if isOwner(resource.data.senderId) || isOwner(resource.data.receiverId) || isAdmin() || isSuperAdmin();
      
      // Create: Anyone signed in
      allow create: if isSignedIn();
      
      // Update: Participants (e.g. mark as read)
      allow update: if isOwner(resource.data.senderId) || isOwner(resource.data.receiverId) || isAdmin() || isSuperAdmin();
    }

    // --- Progress/Application Tracking ---
    match /progress/{userId} {
      allow read: if isOwner(userId) || isAdmin() || isSuperAdmin();
      allow write: if isAdmin() || isSuperAdmin();
    }

    // --- Tasks ---
    match /tasks/{taskId} {
      allow read: if isOwner(resource.data.assignedTo) || isAdmin() || isSuperAdmin();
      allow write: if isAdmin() || isSuperAdmin(); // Only admins assign tasks
      allow update: if isOwner(resource.data.assignedTo) || isAdmin() || isSuperAdmin(); // Students can mark complete?
    }

    // --- Notifications ---
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.userId) || (resource.data.userId == 'super_admin' && isSuperAdmin());
      allow create: if true; // Public for password reset requests
      allow update: if isOwner(resource.data.userId) || (resource.data.userId == 'super_admin' && isSuperAdmin());
    }

    // --- Audit Log ---
    match /audit_log/{logId} {
      allow read: if isSuperAdmin();
      allow create: if isSignedIn();
    }
  }
}
